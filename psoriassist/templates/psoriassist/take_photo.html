{% extends 'psoriassist/base.html' %}
{% load staticfiles %}
{% block js %}
    <script src={% static 'js/webcam.js' %}></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
{% endblock %}

{% block css %}
    <link rel="stylesheet" href={% static 'css/take_photo.css' %}>
{% endblock %}

{% block body %}
    <div class="container">
        <div class="row">

            <div class="col-md-4">
                <div class="photo" id="my_camera" style="width:320px; height:240px;"></div>
                <div id="pre_take_buttons">
                    <a class="take-photo btn btn-warning btn-rounded waves-effect waves-light"
                       onClick="preview_snapshot()">Take Snapshot</a>
                </div>
                <form>
                    <div id="post_take_buttons" style="display:none">
                        <a class="take-photo btn btn-warning btn-rounded waves-effect waves-light"
                           onClick="cancel_preview()">Take Another</a>
                        <a class="take-photo btn btn-warning btn-rounded waves-effect waves-light"
                           onClick="save_photo()">Save Photo</a>
                    </div>
                </form>
                <div class=" photo" id="my_result">
                </div>
            </div>


            <div class="col-md-4">
                {% include 'psoriassist/body_svg.html' %}
            </div>


        </div>

    </div>



    <script language="JavaScript">
        Webcam.attach('#my_camera');

        function take_snapshot() {
            Webcam.snap(function (data_uri) {
                document.getElementById('my_result').innerHTML = '<img src="' + data_uri + '"/>';
            });
        }

        function preview_snapshot() {
            // freeze camera so user can preview pic
            Webcam.freeze();

            // swap button sets
            $('#pre_take_buttons').css('display', 'none');
            $('#post_take_buttons').css('display', '');
        }

        function cancel_preview() {
            // cancel preview freeze and return to live camera feed
            Webcam.unfreeze();

            // swap buttons back
             $('#pre_take_buttons').css('display', '');
            $('#post_take_buttons').css('display', 'none');
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        function sendPhoto(img){
                var imgInfo = {
                    image: img,
                    username: $('.username').text()
                };
            var csrftoken = getCookie('csrftoken');

               $.ajax({
                    type: "POST",
                    url: {% url 'psoriassist:camera' %},
                    data: {
                        imgInfo :imgInfo,
                        csrfmiddlewaretoken: csrftoken
                    },
                    dataType: 'JSON',
                    success: function(data){
                        console.log(data)
                    }

                });
            }


        function save_photo() {
            // actually snap photo (from preview freeze) and display it
            Webcam.snap(function (data_uri) {
                // display results in page
                document.getElementById('my_result').innerHTML =
                        '<h1>Here is your image:</h1>' +
                        '<img src="' + data_uri + '"/>';

                // swap buttons back
                document.getElementById('pre_take_buttons').style.display = '';
                document.getElementById('post_take_buttons').style.display = 'none';
                sendPhoto(data_uri)


            })
        }





    </script>

    {#    <a href="javascript:void(take_snapshot())">Take Snapshot</a>#}
{% endblock %}